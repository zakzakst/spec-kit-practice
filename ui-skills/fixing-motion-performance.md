---
name: fixing-motion-performance
description: アニメーションのパフォーマンスの問題を修正
---

# fixing-motion-performance

アニメーションのパフォーマンスの問題を修正

## 使い方

- `/fixing-motion-performance`
  これらの制約を、この会話内のすべての UI アニメーション作業に適用します。

- `/fixing-motion-performance <file>`
  以下のすべてのルールに照らしてファイルを確認し、報告してください:
  - 違反（正確な行または抜粋を引用してください）
  - なぜそれが重要なのか（短い一文）
  - 具体的な修正（コードレベルの提案）

明示的に要求されない限り、アニメーションライブラリを移行しないでください。既存のスタック内でルールを適用してください。

## いつ利用するか

以下のガイドラインを参考にしてください:

- UIアニメーションの追加または変更（CSS、WAAPI、Motion、rAF、GSAP）
- ぎこちないインタラクションや遷移をリファクタリングする
- スクロール連動モーションやスクロール時に表示する機能を実装する
- レイアウト、フィルター、マスク、グラデーション、CSS変数のアニメーション化
- 意志変化、変換、測定を使用するコンポーネントを確認する

## レンダリング手順の用語集

- composite: transform, opacity
- paint: color, borders, gradients, masks, images, filters
- layout: size, position, flow, grid, flex

## 優先度別のルールカテゴリ

| 優先度 | カテゴリ               | 影響度 |
| ------ | ---------------------- | ------ |
| 1      | 決してやらないパターン | 重要   |
| 2      | メカニズムを選択する   | 重要   |
| 3      | 測定                   | 高     |
| 4      | スクロール             | 高     |
| 5      | ペイント               | 中-高  |
| 6      | レイヤー               | 中     |
| 7      | ぼかしとフィルター     | 中     |
| 8      | view transitions       | 低     |
| 9      | ツールの境界           | 重要   |

## クイックリファレンス

### 1. 決してやらないパターン（重要）

- レイアウトの読み取りと書き込みを同じフレーム内でインターリーブしない
- 大きな面や意味のある面ではレイアウトを連続的にアニメーション化しない
- scrollTop、scrollY、またはscrollイベントからアニメーションを駆動しないでください。
- requestAnimationFrame は停止条件なしでループしません
- レイアウトを測定または変更する複数のアニメーションシステムを混在させないでください。

### 2. メカニズムを選択する（重要）

- transformとopacityを動きのデフォルトにする
- インタラクションで必要な場合にのみ JS 駆動アニメーションを使用する
- ペイントやレイアウトアニメーションは、小さな孤立したサーフェス上でのみ許容されます
- 連続した動きよりもワンショット効果の方が受け入れられることが多い
- モーションを完全に削除するよりも、テクニックをダウングレードすることを好む

### 3. 測定（高）

- 一度測定し、transformまたはopacityを使用してアニメーション化する
- 書き込み前にすべてのDOM読み取りをバッチ処理する
- アニメーション中にレイアウトを繰り返し読み上げない
- レイアウトのような効果にはFLIPスタイルのトランジションを好む
- バッチ測定と書き込みのアプローチを好む

### 4. スクロール（高）

- スクロールリンクモーションが利用可能な場合は、スクロールまたはタイムラインの表示を優先します。
- 可視性と一時停止にはIntersectionObserverを使用する
- アニメーションのスクロール位置をポーリングしない
- 画面外のときにアニメーションを一時停止または停止する
- スクロール連動モーションは、大きな表面での連続レイアウトやペイントをトリガーしてはならない。

### 5. ペイント（中-高）

- ペイントをトリガーするアニメーションは、小さな独立した要素にのみ許可されます。
- 大きなコンテナ上のペイントを多用するプロパティをアニメーション化しない
- transform, opacity, positionのCSS変数をアニメーション化しない
- 継承されたCSS変数をアニメーション化しない
- アニメーションCSS変数をローカルにスコープし、継承を避ける

### 6. レイヤー（中）

- コンポジターの動きにはレイヤーの昇格が必要です。決してそれを前提としないでください。
- 一時的かつ外科的にwill-changeを使用する
- 多数のまたは大規模なプロモーション レイヤーを避ける
- パフォーマンスが重要な場合はツールを使用してレイヤーの動作を検証する

### 7. ぼかしとフィルター（中）

- ぼかしアニメーションを小さく保つ（<=8px）
- ぼかしは短時間の1回限りの効果にのみ使用してください
- ぼかしを継続的にアニメーション化しない
- 大きな表面ではぼかしをアニメーション化しないでください
- ぼかしの前に不透明度と翻訳を優先する

### 8. view transitions（低）

- ナビゲーションレベルの変更にのみview transitionsを使用する
- インタラクションの多いUIではview transitionsを避ける
- 中断やキャンセルが必要な場合、view transitionsを避ける
- サイズ変更をレイアウトトリガーとして扱う

### 9. ツールの境界（重要）

- 明示的に要求されない限り、アニメーションライブラリを移行または書き換えないでください
- 既存のアニメーションシステム内でこれらのルールを適用する
- APIを部分的に移行したり、同じコンポーネント内でスタイルを混在させたりしないでください。

## レビューガイダンス

- 重要なルールを最初に強制する（パターンやツールの境界は強制しない）
- 意図に合った最も安価なレンダリング作業を選択する
- デフォルト以外の選択肢については、それを正当化する制約（表面のサイズ、持続時間、またはインタラクション要件）を明記する
- レビューする際には、理論よりも実行可能なメモや具体的な代替案を優先する
