---
url: https://learn.microsoft.com/ja-jp/azure/architecture/ai-ml/guide/ai-agent-design-patterns
---

# AI エージェントオーケストレーションパターン

## 適切なレベルの複雑さから始める

マルチエージェント オーケストレーション パターンを採用する前に、シナリオに必要かどうかを評価します。エージェント アーキテクチャはさまざまな複雑さに存在し、各レベルでは調整のオーバーヘッド、待機時間、コストが発生します。要件を確実に満たす最も低いレベルの複雑さを使用します。

### 直接モデル呼び出し

| 項目           | 内容                                                                                                             |
| -------------- | ---------------------------------------------------------------------------------------------------------------- |
| 概要           | 適切に作成されたプロンプトを使用した 1 つの言語モデル呼び出し。 エージェント ロジックなし、ツール アクセスなし。 |
| いつ使用するか | モデルが 1 回のパスで完了できる分類、要約、翻訳、およびその他の単一ステップ タスク。                             |
| 考慮事項       | 最も複雑なオプション。 プロンプト エンジニアリングで問題を解決できる場合は、エージェントは必要ありません。       |

### ツールを使用した単一エージェント

| 項目           | 内容                                                                                                                                                                                                                                 |
| -------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 概要           | 使用可能なツール、ナレッジ ソース、API から選択することで、理由と動作を行う 1 つのエージェント。 エージェントは、複数のモデル呼び出しとツール呼び出しをループ処理して結果を絞り込むことができます。                                  |
| いつ使用するか | 注文の状態の検索やデータベースのクエリなど、一部の要求で動的なツールの使用が必要な 1 つのドメイン内のさまざまなクエリ。                                                                                                              |
| 考慮事項       | 多くの場合、エンタープライズ ユース ケースに適した既定値です。 動的ロジックを引き続き許可しながら、マルチエージェントのセットアップよりもデバッグとテストが簡単です。 反復制限を設定して、無限のツール呼び出しループから保護します。 |

### マルチエージェント オーケストレーション

| 項目           | 内容                                                                                                                                                                                                                         |
| -------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 概要           | 複数の特殊なエージェントが、問題を解決するために調整します。オーケストレーターまたはピア ベースのプロトコルは、作業の分散、コンテキスト共有、および結果の集計を管理します。                                                  |
| いつ使用するか | 機能間またはクロスドメインの問題、エージェントごとに個別のセキュリティ境界を必要とするシナリオ、または並列特殊化の恩恵を受けるタスク。                                                                                       |
| 考慮事項       | 調整オーバーヘッド、待機時間、および障害モードを追加します。プロンプトの複雑さ、ツールの過負荷、またはセキュリティの要件により、単一のエージェントが確実にタスクを処理できないことを示すことで、追加の複雑さを正当化します。 |

このガイドの残りの部分では、調整の課題が最も重要なマルチエージェント レベルのオーケストレーション パターンに焦点を当てています。

## 概要

複数のエージェントを使用すると、モノリシック シングル エージェント ソリューションと比較して、いくつかの利点があります。

- **専修**：個々のエージェントは、特定のドメインまたは機能に集中できるため、コードとプロンプトの複雑さが軽減されます。
- **スケーラビリティ**：エージェントは、システム全体を再設計せずに追加または変更できます。
- **保守性**：テストとデバッグは個々のエージェントに重点を置くことができるため、これらのタスクの複雑さが軽減されます。
- **最適化**：各エージェントは、個別のモデル、タスク解決アプローチ、知識、ツール、コンピューティングを使用して、その結果を達成できます。

---

### シーケンシャル オーケストレーション

定義済みの線形順序で AI エージェントをチェーンします。 各エージェントは、前のエージェントからの出力をシーケンスで処理し、特殊化された変換のパイプラインを作成します。

#### 使用するタイミング

- 明確な線形依存関係と予測可能なワークフローの進行を持つ
- 並列化できないワークフロー
- 1つの AI エージェントの処理が失敗したり遅延したりしても、タスク全体が完了できるシステム

#### 回避するタイミング

- 並列化できるワークフロー
- 初期段階では、エラーが発生したり、低品質の出力が生成されたりする可能性があり、累積エラー出力を使用して後の手順が処理されないようにする必要がある
- AI エージェントは、作業を引き継ぐのではなく、共同作業を行う必要がある
- ワークフローにはバックトラッキングまたはイテレーションが必要
- 中間結果によって処理の内容が変化する

#### 例

- 法律事務所のドキュメント管理ソフトウェアは、契約生成に順次エージェントを使用します

---

### コンカレント オーケストレーション

同じタスクで複数の AI エージェントを同時に実行します。このパターンは、同じ問題に対して多様な分析情報やアプローチが必要なシナリオに対処します。 順次処理の代わりに、すべてのエージェントが並列に動作するため、全体的な実行時間が短縮され、問題領域が包括的にカバーされます。

エージェントは独立して動作し、結果を互いに引き渡しません。 エージェントは、独立した処理の一部として独自のオーケストレーション アプローチを使用して、追加の AI エージェントを呼び出す場合があります。

#### 使用するタイミング

- 複数の独立した視点や、技術、ビジネス、創造的なアプローチなど、同じ問題に貢献できるさまざまな特殊化の恩恵を受けるタスク（下記シナリオ例）
  - ブレーンストーミング
  - アンサンブル推論
  - クォーラムと投票に基づく決定
- 並列処理によって待機時間が短縮される、時間に依存するシナリオ

#### 回避するタイミング

- エージェントが、互いの作業に基づいて構築するか、特定のシーケンスで蓄積されたコンテキストを必要とする
- タスクには、定義されたシーケンスで実行された特定の順序の操作または確定的で再現可能な結果が必要
- モデル クォータなどのリソース制約によって、並列処理が非効率的または不可能になる
- エージェントは、同時に実行されている間、共有状態または外部システムへの変更を確実に調整することができない
- 各エージェントからの矛盾または競合する結果を処理するための明確な競合解決戦略がない
- 結果集計ロジックが複雑すぎるか、結果の品質が低下する

#### 例

- ある金融サービス会社は、さまざまな種類の分析に特化した同時実行エージェントを使用して同じ在庫を同時に評価するインテリジェントなアプリケーションを構築しました

---

### グループチャット オーケストレーション

グループ チャット オーケストレーション パターンを使用すると、複数のエージェントが、ディスカッションを通じて共同作業を行う共有会話スレッドに参加することで、問題の解決、決定、作業の検証を行うことができます。 チャット マネージャーは、次に応答できるエージェントを決定し、コラボレーションブレーンストーミングから構造化された品質ゲートまで、さまざまな対話モードを管理することでフローを調整します。

このパターンは、グループディスカッションを通じて決定に到達するために最適に達成されるシナリオに対処します。 これらのシナリオには、協調的な考え方、構造化された検証、または品質管理プロセスが含まれる場合があります。

このパターンは、人間が必要に応じて動的チャット マネージャーの責任を引き受け、生産性の高い結果に向けて会話を導くことができる、人間のループ内シナリオに適しています。

#### 使用するタイミング

**共同作業のシナリオ**

- 異なる視点と知識ソースを持つエージェントがチャットに対する互いの貢献に基づいて構築する創造的なブレーンストーミング セッション
- 議論とコンセンサス構築の恩恵を受ける意思決定プロセス
- ディスカッションによる反復的な絞り込みを必要とする意思決定シナリオ
- 機能間の対話を必要とする学際的な問題

**検証と品質管理のシナリオ**

- 構造化されたレビュー プロセスとイテレーションを含む品質保証要件
- 複数の専門家の視点を必要とするコンプライアンスと規制の検証
- 作成と検証の間の懸念事項を明確に分離して編集レビューを必要とするコンテンツ作成ワークフロー

#### 回避するタイミング

- 基本的なタスク委任または線形パイプライン処理で十分
- リアルタイム処理の要件によって、ディスカッションオーバーヘッドは許容できない
- 議論なしで明確な階層的意思決定または決定論的ワークフローがより適切
- チャット マネージャーには、タスクが完了したかどうかを判断する客観的な方法がない

#### 例

- 市の公園とレクリエーション部門は、グループ チャット オーケストレーションを含むソフトウェアを使用して、新しい公園開発の提案を評価します。

---

### ハンドオフ オーケストレーション

ハンドオフ オーケストレーション パターンを使用すると、特殊なエージェント間でタスクを動的に委任できます。 各エージェントは、手元のタスクを評価し、コンテキストと要件に基づいてタスクを直接処理するか、より適切なエージェントに転送するかを決定できます。

このパターンは、タスクに最適なエージェントが事前にわかっていない、またはタスクの要件が処理中にのみ明確になるシナリオに対処します。

#### 使用するタイミング

- 専門的な知識またはツールを必要とするが、必要なエージェントの数またはその順序を事前に決定できないタスク
- 処理中に専門知識の要件が生じ、コンテンツ分析に基づく動的なタスク ルーティングが発生するシナリオ
- 複数のドメインにまたがる問題で、異なる専門家が順番に働くことが必要
- 1 つのエージェントが機能制限に達し、次にタスクを処理する必要があるエージェントを示すために事前に定義できる論理リレーションシップとシグナル

#### 回避するタイミング

- 適切なエージェントまたはエージェントのシーケンスは、最初の入力から識別できます。 その場合は、決定論的ルーティングまたは単純なディスパッチャーを使用して、入力を事前に分類し、処理でアクティブな役割を果たさずに適切なエージェントに送信します
- タスク ルーティングは決定論的でルールベースであり、動的コンテキスト ウィンドウや動的解釈に基づくものではない
- 最適でないルーティングの決定は、ユーザー エクスペリエンスの低下や不満につながる可能性がある
- タスクに対処するには、複数の操作を同時に実行する必要がある
- 無限ハンドオフループを回避したり、エージェント間の過度のバウンスを避けるのは困難

#### 例

- 通信顧客関係管理 (CRM) ソリューションは、カスタマー サポート Web ポータルでハンドオフ エージェントを使用します。 最初のエージェントは、顧客を支援し始めますが、会話中に専門的な専門知識が必要であることを発見します。 最初のエージェントは、顧客の懸念に対処するために、最も適切なエージェントにタスクを渡します。

---

### マゼンティック オーケストレーション

マゼンティック オーケストレーション パターンは、事前に定義されたアプローチ計画を持たないオープンエンドで複雑な問題に対応するように設計されています。 通常、このパターンのエージェントには、外部システムで直接変更できるツールがあります。 このアプローチを実装する場合と同じように、問題を解決するためのアプローチを構築して文書化することに重点を置きます。

#### 使用するタイミング

- 事前に定義されたソリューション パスがない複雑なユース ケースまたはオープン エンドのユース ケース
- 有効なソリューション パスを開発するために、複数の特殊なエージェントからの入力とフィードバックを検討する必要がある
- AI システムが、人間が実装の前後にレビューできる完全に開発されたアプローチ計画を生成するための要件
- 外部システムと対話したり、外部リソースを消費したり、実行中のシステムの変更を誘発したりするツールを備えたエージェント。 エージェントがタスクに従うことを許可する前に、それらのエージェントがどのようにシーケンスされるかを示す文書化されたプランをユーザーに提示できる

#### 回避するタイミング

- ソリューション パスが開発されているか、決定論的な方法でアプローチする必要がある
- 台帳を作成する必要がない
- タスクの複雑さが低く、より単純なパターンで解決できる
- 速度を最適化せず、実行可能な計画の構築と議論に重点を置いているため、この作業は時間の影響を受ける
- 解決への明確なパスがない頻繁なストールまたは無限ループが予想される

#### 例

- サイト信頼性エンジニアリング (SRE) チームは、マゼンティック オーケストレーションを使用してリスクの低いインシデント対応シナリオを処理する自動化を構築しました。

---

## パターンの選択

| パターン         | 概要                                                                   | 経路選択                                                        | 最適な用途                                                           | 注意点                                                 |
| ---------------- | ---------------------------------------------------------------------- | --------------------------------------------------------------- | -------------------------------------------------------------------- | ------------------------------------------------------ |
| シーケンシャル   | 線形パイプライン。各エージェントは、前のエージェントの出力を処理します | 決定論的な定義済みの順序                                        | 明確なステージ依存関係を使用したステップ バイ ステップの絞り込み     | 初期段階での障害が伝播する。並列処理なし               |
| コンカレント     | エージェントは、同じ入力で独立して動作します                           | 決定論的または動的なエージェントの選択                          | 複数の観点からの独立した分析;待機時間に依存するシナリオ              | 結果が矛盾する場合は競合解決が必要です。リソース集中型 |
| グループチャット | エージェントが共有スレッドに貢献する                                   | チャット管理者が順序を制御する                                  | コンセンサス構築、ブレーンストーミング、反復的な作成者チェッカー検証 | 会話ループ。多くのエージェントで制御するのが難しい     |
| ハンドオフ       | 動的委任。一度に 1 つのアクティブなエージェント                        | エージェントが制御を転送するタイミングを決定する                | 処理中に適切なスペシャリストが出現するタスク                         | 無限ハンドオフループ、予期しないルーティング パス      |
| マゼンティック   | マネージャー エージェントによるタスク台帳のビルドと調整                | マネージャー エージェントによるタスクの動的な割り当てと並べ替え | 事前に定義されたソリューション パスのないオープンエンドの問題        | 収束が遅い、あいまいな目標で停滞する                   |

---

## 実装に関する考慮事項

### 単一エージェント、マルチツール

- ナレッジ ソースとツールの数が増えるにつれて、予測可能なエージェント エクスペリエンスを提供することが困難になります。 1 つのエージェントでシナリオを確実に解決できる場合は、そのアプローチを採用することを検討してください。 多くの場合、意思決定とフロー制御のオーバーヘッドは、タスクを複数のエージェントに分割する利点を超えています。

### 決定論的ルーティング

- 一部のパターンでは、エージェント間のフローを決定論的にルーティングする必要があります。 他のユーザーは、エージェントに依存して独自のルートを選択します。 エージェントがコードなし環境またはローコード環境で定義されている場合、それらの動作を制御できない可能性があります。

### コンテキストと状態の管理

- 多くの場合、AI エージェントにはコンテキスト ウィンドウが限られています。 この制約は、複雑なタスクを処理する能力に影響を与える可能性があります。特に、エージェントの移行ごとにコンテキストが大きくなるとします。 これらのパターンを実装するときは、次のエージェントが有効にするために必要なコンテキストを決定します。 一部のシナリオでは、これまでに収集された完全な生のコンテキストが必要です。 他のシナリオでは、以前のエージェント出力の概要など、圧縮されたバージョンの方が適しています。

### 信頼性

- 適切に機能するエージェントとそれらの間の信頼性の高い遷移が必要です。 多くの場合、ノード障害、ネットワーク パーティション、メッセージ損失、カスケード エラーなどの従来の分散システムの問題が発生します。 これらの課題に対処するには、軽減策を実施する必要があります。
  - タイムアウトと再試行のメカニズムを実装
  - パターン障害の中で 1 つ以上のエージェントを処理するグレースフル デグラデーションの実装を含める
  - サーフェス エラーは非表示にするのではなく、ダウンストリーム エージェントとオーケストレーター ロジックが適切に応答できるようにする
  - 次のエージェントに渡す前に、エージェントの出力を検証する
  - エージェントの依存関係に対するサーキットブレーカーパターンを検討する
  - エージェントは、できるだけ互いに隔離され、エージェント間で単一障害点を共有しないように設計

### セキュリティ

- 設計パターンに適切なセキュリティ メカニズムを実装することで、AI システムが攻撃やデータ漏えいにさらされるリスクを最小限に抑えることができます。 エージェント間の通信をセキュリティで保護し、各エージェントの機密データへのアクセスを制限することは、重要なセキュリティ設計戦略です

### コストの最適化

- マルチエージェント オーケストレーションはモデル呼び出しを乗算し、各エージェントは命令、コンテキスト、推論、およびツールの対話にトークンを使用します。 選択したパターンは、コストに直接影響します

### 可観測性とテスト

- AI システムを複数のエージェントに分散させるには、適切な機能を確保するために、各エージェントを個別に監視し、システム全体をテストする必要があります。 監視とテストの戦略を設計するときは、次の推奨事項を考慮してください
  - すべてのエージェント操作と引き継ぎを監視
  - ベースラインを確立し、ボトルネックを見つけ、最適化できるように、各エージェントのパフォーマンスとリソース使用状況のメトリックを追跡
  - 個々のエージェントのテスト可能なインターフェイスを設計
  - マルチエージェント ワークフローの統合テストを実装します。 エージェントの出力は非決定的であるため、正確に一致するアサーションではなく、スコアリングルーブリックやLLMの評価を用いることを推奨

### 人間の参加

- いくつかのオーケストレーション パターンでは、グループ チャットのオブザーバー、作成者チェッカー ループのレビュー担当者、ハンドオフオーケストレーションとマゼンティク オーケストレーションのエスカレーション ターゲットなど、人間のループ内 (HITL) の関与がサポートされています。 人間の入力が必要なポイント、その入力が省略可能か必須か、および人間の応答が、洗練のためにエージェントにループバックするワークフローまたはフィードバックを進める承認であるかどうかを特定します
- 必須ゲートは、その手順でオーケストレーションを同期するため、これらのチェックポイントで状態を保持して、前のエージェント作業を再生せずに再開できるようにします

### 一般的な落とし穴とアンチパターン

- シンプルなシーケンシャルオーケストレーションまたはコンカレントオーケストレーションで十分である場合に、複雑なパターンを採用し、不必要なコーディネーションの複雑さを生み出す
- 意味のある特殊化を提供しないエージェントを追加する
- 複数ホップ通信の待機時間の影響を見落とす
- 同時実行エージェント間で変更可能な状態を共有すると、エージェントの境界を越えた同期更新が想定されるため、トランザクションに一貫性のないデータが発生する可能性がある
- 本質的に非決定的なワークフローに決定論的パターンを使用する
- 本質的に確定的なワークフローに対して非決定的パターンを使用する
- 同時実行オーケストレーションを選択した場合のリソース制約の無視
- エージェントがより多くの情報を蓄積し、そのモデルを参照してタスクを進めるにつれてコンテキスト ウィンドウが拡大するため、過剰なモデル リソースを消費する
